<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Muhur</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">

<script src="js/swisseph.js"></script>
<script src="js/panchang-engine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box;max-width:100%;}
:root{--glass:rgba(255,255,255,.28);--border:rgba(255,255,255,.35);--text:#000;}
body.dark{--glass:rgba(0,0,0,.38);--border:rgba(255,255,255,.18);--text:#fff;background:#0d0d0d;}
body{margin:0;min-height:100vh;background:linear-gradient(135deg,#f6d365,#fda085);font-family:system-ui;color:var(--text);overflow-y:auto;-webkit-overflow-scrolling:touch;}
.app{width:100%;max-width:420px;height:100vh;max-height:100svh;margin:auto;padding:14px;border-radius:20px;border:1px solid var(--border);backdrop-filter:blur(16px);background:var(--glass);box-shadow:0 25px 45px rgba(0,0,0,.25);position:relative;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.toggle{position:absolute;top:12px;right:12px;width:42px;height:42px;border-radius:50%;border:none;cursor:pointer;font-size:18px;background:var(--glass);}
h2{text-align:center;margin:8px 0}
select,button{width:100%;padding:12px;margin-bottom:8px;border-radius:10px;border:1px solid var(--border);background:var(--glass);color:var(--text);font-size:15px;}
.box{width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:1px solid var(--border);background:var(--glass);}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:12px;}
.day{padding:6px;border-radius:8px;text-align:center;cursor:pointer;background:rgba(255,255,255,.35);}
.today{border:2px solid #00ffc8;}
.muhurta{padding:6px;margin:4px 0;border-radius:6px;font-size:13px;}
.auspicious{background:#b9f6ca}
.neutral{background:#fff3cd}
.inauspicious{background:#f8d7da}
.night{background:#cce5ff}
.muhurta.active{outline:2px solid #00ffc8;background:#d1fff0;font-weight:600;}
footer{text-align:center;font-size:12px;opacity:.8;margin-top:10px;}
</style>
</head>

<body>
<div class="app">
<button class="toggle" onclick="document.body.classList.toggle('dark')">üåô</button>
<h2>üåû Muhur</h2>

<select id="ayanamsa" onchange="setAyanamsa(this.value)">
 <option value="SIDM_LAHIRI">Lahiri</option>
 <option value="SIDM_RAMAN">Raman</option>
 <option value="SIDM_KRISHNAMURTI">KP</option>
</select>

<button onclick="useGPS()">üìç Use My Location</button>
<select id="city"></select>

<div class="box" id="locationBox"></div>
<div class="box" id="panchang"></div>

<div class="box">
<h3>üìÖ Monthly Panchang</h3>
<div id="calendar" class="calendar"></div>
</div>

<div class="box" id="muhurtas"></div>

<button onclick="exportImage()">üì∏ Export Image</button>
<button onclick="exportDailyPDF()">üìñ Daily PDF</button>
<button onclick="exportMonthlyPDF()">üìò Monthly PDF</button>

<footer>¬© Manik Roy 2025. All Rights Reserved. ‚Äî Muhur</footer>
</div>

<script>
// ==== Global variables ====
let lastLat = 28.6139; // default Delhi
let lastLon = 77.2090;

// ==== City dropdown & default ====
const cities = {
  "Delhi, India": [28.6139, 77.2090],
  "Mumbai, India": [19.076, 72.8777],
  "London, UK": [51.5074, -0.1278],
  "New York, USA": [40.7128, -74.006],
  "Tokyo, Japan": [35.6895, 139.6917]
};

const sel = document.getElementById("city");
Object.keys(cities).forEach(city=>{
  let option = document.createElement("option");
  option.textContent = city;
  sel.appendChild(option);
});

// default selection
sel.value = "Delhi, India";
[lastLat, lastLon] = cities[sel.value];
document.getElementById("locationBox").innerHTML = `<b>Location:</b> ${sel.value}`;

// onchange
sel.onchange = ()=>{
  [lastLat,lastLon] = cities[sel.value];
  document.getElementById("locationBox").innerHTML = `<b>Location:</b> ${sel.value}`;
  refreshAll();
};

// ==== GPS fallback ====
function useGPS() {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      p=>{
        lastLat = p.coords.latitude;
        lastLon = p.coords.longitude;
        document.getElementById("locationBox").innerHTML = `<b>Location:</b> Current GPS`;
        refreshAll();
      },
      ()=>{
        console.warn("GPS denied/unavailable. Using default city.");
        refreshAll();
      }
    );
  } else {
    console.warn("Geolocation not supported. Using default city.");
    refreshAll();
  }
}

// ==== Ayanamsa toggle ====
function setAyanamsa(mode){
 swe.set_sid_mode(swe[mode]);
 refreshAll();
}

// ==== Panchang rendering ====
function renderPanchang(date=new Date()){
 const data = panchangAt(date);
 const tEnd = jdToLocalTime(findTithiEnd(date));
 const nEnd = jdToLocalTime(findNakshatraEnd(date));
 const yEnd = jdToLocalTime(findYogaEnd(date));

 document.getElementById("panchang").innerHTML = `
  <b>Tithi:</b> ${tithiNames[data.tithi]} <small>(ends ${tEnd})</small><br>
  <b>Nakshatra:</b> ${nakNames[data.nakshatra]} <small>(ends ${nEnd})</small><br>
  <b>Yoga:</b> ${yogaNames[data.yoga]} <small>(ends ${yEnd})</small><br>
  <b>Festival:</b> ${festivalAt(date,lastLat,lastLon)||'‚Äî'}
 `;
}

// JD ‚Üí Local Time
function jdToLocalTime(jd){
 const utc = swe.revjul(jd, swe.GREG_CAL);
 const d = new Date(Date.UTC(
  utc.year, utc.month-1, utc.day,
  Math.floor(utc.hour),
  Math.floor((utc.hour%1)*60)
 ));
 return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

// ==== Monthly Calendar ====
function buildCalendar(){
 const cal=document.getElementById("calendar");
 cal.innerHTML="";
 const d=new Date(),y=d.getFullYear(),m=d.getMonth();
 const days=new Date(y,m+1,0).getDate();
 for(let i=1;i<=days;i++){
  const dt=new Date(y,m,i);
  const data = panchangAt(dt);
  const div=document.createElement("div");
  div.className="day"+(i===d.getDate()?" today":"");
  div.innerHTML=`${i}<br>${tithiNames[data.tithi]}`;
  div.onclick=()=>loadDate(dt);
  cal.appendChild(div);
 }
}

// ==== Load selected date ====
function loadDate(date){
 renderPanchang(date);
 renderMuhurtas(date);
 highlightCurrentMuhurta(date);
}

// ==== Muhurta rendering ====
function renderMuhurtas(date=new Date()){
 const dayLength = 12; // simplified
 const muhurtasHTML = muhurtaNames.map((name,i)=>{
  const startH = i<15 ? 6+i : 18+(i-15);
  const endH = startH+1;
  return `<div class="muhurta ${muhurtaType[i]}">${startH}:00 - ${endH}:00 ‚Äî ${name}</div>`;
 }).join('');
 document.getElementById("muhurtas").innerHTML = muhurtasHTML;
}

// Highlight current Muhurta
function highlightCurrentMuhurta(date){
 const now = new Date();
 const muhEl=document.querySelectorAll(".muhurta");
 muhEl.forEach(el=>el.classList.remove("active"));
 const idx=Math.floor(now.getHours()%35);
 if(muhEl[idx]) { muhEl[idx].classList.add("active"); muhEl[idx].scrollIntoView({behavior:"smooth", block:"center"});}
}

// ==== Export functions ====
function exportImage(){html2canvas(document.body).then(c=>{let a=document.createElement("a");a.href=c.toDataURL();a.download="Panchang.png";a.click();});}
function exportDailyPDF(){const{jsPDF}=window.jspdf;const p=new jsPDF();p.html(document.querySelector(".app"),{callback:()=>p.save("Daily-Panchang.pdf")});}
function exportMonthlyPDF(){const{jsPDF}=window.jspdf;const p=new jsPDF();p.text("Monthly Panchang",10,10);p.save("Monthly-Panchang.pdf");}

// ==== Refresh UI ====
function refreshAll(){renderPanchang(new Date());renderMuhurtas(new Date());buildCalendar();}

// ==== Init ====
refreshAll();

// ==== Register Service Worker ====
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('/sw.js').then(()=>console.log("SW Registered")).catch(e=>console.log(e));
}
</script>
</body>
</html>
